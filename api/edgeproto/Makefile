# Makefile

GOPATH		= ../../../../..
PROTODEPS	:= $(shell go list -f '{{ .Dir }}' -m \
	github.com/grpc-ecosystem/grpc-gateway \
	github.com/gogo/googleapis \
	github.com/gogo/protobuf \
	github.com/edgexr/edge-cloud-platform)
GW		:= $(word 1,$(PROTODEPS))
APIS		:= $(word 2,$(PROTODEPS))
GOGO		:= $(word 3,$(PROTODEPS))
PROJECT		:= $(word 4,$(PROTODEPS))
EDGEPROTOGENDIR	:= $(PROJECT)/tools/edgeprotogen
PROTOGENDIR	:= $(PROJECT)/tools/protogen
INCLUDE		:= -I. -I${GW} -I${APIS} -I${GOGO} -I${GOPATH} -I${EDGEPROTOGENDIR} -I${PROTOGENDIR}
BUILTIN		= Mgoogle/protobuf/timestamp.proto=github.com/gogo/protobuf/types,Mgoogle/protobuf/empty.proto=github.com/gogo/protobuf/types,Mgoogle/api/annotations.proto=github.com/gogo/googleapis/google/api,Mgoogle/protobuf/field_mask.proto=github.com/gogo/protobuf/types,Mgoogle/protobuf/any.proto=github.com/gogo/protobuf/types,Mgogoproto/gogo.proto=github.com/gogo/protobuf/gogoproto

NOTIFYDIR	= ../../pkg/notify
CMDDIR		= ../../pkg/gencmd
TESTDIR		= ../../test/testutil
CTRLDIR		= ../../cmd/controller
ORMAPIDIR	= ../../api/ormapi
ORMDIR		= ../../pkg/mc/orm
CTRLCLIENTDIR	= ../../pkg/mc/ctrlclient
ORMTESTUTILDIR	= ../../pkg/mc/orm/testutil
MCCTLDIR	= ../../pkg/mcctl/ormctl

PROTOS		= *.proto

build:
	protoc ${INCLUDE} --gomex_out=plugins=grpc+mex,${BUILTIN}:. $(PROTOS)
	protoc ${INCLUDE} --grpc-gateway_out=${BUILTIN}:. $(PROTOS)
	protoc ${INCLUDE} --notify_out=${BUILTIN}:${NOTIFYDIR} $(PROTOS)
	protoc ${INCLUDE} --cmd_out=${BUILTIN}:${CMDDIR} $(PROTOS)
	protoc ${INCLUDE} --test_out=${BUILTIN}:${TESTDIR} $(PROTOS)
	protoc ${INCLUDE} --controller-test_out=${BUILTIN}:${CTRLDIR} $(PROTOS)
	protoc ${INCLUDE} --controller_out=${BUILTIN}:${CTRLDIR} version.proto
	protoc ${INCLUDE} --mc2_out=${BUILTIN},genapi,pkg=ormapi:${ORMAPIDIR} $(PROTOS)
	protoc ${INCLUDE} --mc2_out=${BUILTIN}:${ORMDIR} $(PROTOS)
	protoc ${INCLUDE} --mc2_out=${BUILTIN},gentest,suffix=_mc2_test.go:${ORMDIR} $(PROTOS)
	protoc ${INCLUDE} --mc2_out=${BUILTIN},genctrlclient,pkg=ctrlclient,suffix=.ctrl.go:${CTRLCLIENTDIR} $(PROTOS)
	protoc ${INCLUDE} --mc2_out=${BUILTIN},gentestutil,pkg=testutil,suffix=_mc2_testutil.go:${ORMTESTUTILDIR} $(PROTOS)
	protoc ${INCLUDE} --mc2_out=${BUILTIN},genctl,pkg=ormctl:${MCCTLDIR} $(PROTOS)

# swagger reads annotations in go code, some of which is generated by mc2
docgen:
	protoc ${INCLUDE} --mc2_out=${BUILTIN}:${ORMDIR} $(PROTOS)

doc:
	(cd $(HOME); go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest)
	protoc ${INCLUDE} --doc_out=./doc --doc_opt=html,index.html *.proto
	protoc ${INCLUDE} --doc_out=./doc --doc_opt=markdown,README.md *.proto
	#swagger annotations for REST APIs
	protoc ${INCLUDE} --swagger_out=logtostderr=true,allow_merge=true:./doc  *.proto

external-doc: build
	mkdir -p ./external-doc
	protoc ${INCLUDE} --swagger_out=logtostderr=true,allow_merge=true,config_file=swagger_config.yaml:./external-doc  *.proto
