# Copyright 2022 MobiledgeX, Inc
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

description: Federation tests

# Unidirectional federation test.
# Main MC is the provider.
# Partner1 MC is the consumer.

tests:
###############################################################
# Setup provider operator platform (main MC)
###############################################################
- includefile: mc_setup_users.yml

- name: user1 creates operators and cloudlets
  actions: [mcapi-create,mcapi-show]
  apifile: '{{datadir2}}/mc_user1_data.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_user1_data_show.yml'
    filetype: mcdata

###############################################################
# Setup consumer operator platform (partner1 MC)
###############################################################
- name: partner1 admin disable verify email so users can be created
  actions: [mcapi-configupdate=mc-partner1,mcapi-configshow=mc-partner1]
  apifile: '{{datadir2}}/mcconfig.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcconfig_partner1.yml'
    filetype: mcconfig

- name: setup federation partner1 platform
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/federation_init_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    dnsregion: "pa"
    ctrlapiaddr: "127.0.0.1:5581"
    ctrlnotifyaddr: "127.0.0.1:27081"
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_init_data_partner1.yml'
    filetype: mcdata

- name: create partner1 platform users
  actions: [mcapi-createusers=mc-partner1]
  apifile: '{{datadir2}}/mc_user_fedop.yml,{{datadir2}}/mc_user_feddev.yml'

- name: setup federation consumer (partner1) operator regional data
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_op_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_op_data_show.yml'
    filetype: mcdata

###############################################################
# Create provider zone bases to map cloudlets to zones
###############################################################
- name: create provider zone bases
  actions: [mcapi-create,mcapi-showproviderzonebases]
  apifile: '{{datadir2}}/federation_providerzonebases.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_providerzonebases.yml'
    filetype: mcdata

###############################################################
# Create federation provider
###############################################################
- name: create federation provider
  actions: [mcapi-create,mcapi-showfederationproviders]
  apifile: '{{datadir2}}/federation_provider.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_provider_show.yml'
    filetype: mcdata

- name: share provider zones
  actions: [mcapi-share,mcapi-showproviderzones]
  apifile: '{{datadir2}}/federation_providerzones.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_providerzones_show.yml'
    filetype: mcdata

###############################################################
# Create federation consumer, link to provider
###############################################################
- name: create federation consumer
  actions: [mcapi-create=mc-partner1,mcapi-showfederationconsumers=mc-partner1]
  apifile: '{{datadir2}}/federation_consumers.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    fedaddr: "https://127.0.0.1:9801"
    tokenurl: "https://127.0.0.1:9900/oauth2/token"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_consumers_show.yml'
    filetype: mcdata

- name: show consumer zones
  actions: [mcapi-showconsumerzones=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_consumerzones_show.yml'
    filetype: mcdata

- name: verify that partner zones are added as cloudlets
  actions: [mcapi-show=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_show_partner1_cloudlets.yml'
    filetype: mcdata

###############################################################
# consumer onboard apps
###############################################################
- name: consumer create dev regional data (apps)
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_apps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_apps_show.yml'
    filetype: mcdata

- name: consumer dev onboard apps
  actions: [mcapi-create=mc-partner1,mcapi-showconsumerappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_consapps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_consapps_show.yml'
    filetype: mcdata

- name: provider show onboarded apps
  actions: [mcapi-showproviderappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_provapps_show.yml'
    filetype: mcdata

###############################################################
# consumer create appinsts on provider cloudlets
###############################################################
- name: consumer create appinsts on provider cloudlets
  actions: [mcapi-create=mc-partner1,mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_appinsts.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_appinsts_show.yml'
    filetype: mcdata

- name: check provider created appinsts
  actions: [mcapi-show]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_appinsts_show.yml'
    filetype: mcdata

- name: check provider MC appinst data
  actions: [mcapi-showproviderappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_provappinsts_show.yml'
    filetype: mcdata

###############################################################
# consumer clean up
###############################################################
- name: consumer delete appinsts
  actions: [mcapi-delete=mc-partner1,mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_appinsts.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_apps_show.yml'
    filetype: mcdata

- name: consumer deboard apps
  actions: [mcapi-delete=mc-partner1,mcapi-showconsumerappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_consapps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_images_show.yml'
    filetype: mcdata

- name: consumer delete images
  actions: [mcapi-delete=mc-partner1,mcapi-showconsumerappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_images.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: provider check no more provider app data
  actions: [mcapi-showproviderappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: consumer delete dev regional data (apps)
  actions: [mcapi-delete=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_apps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_region_empty.yml'
    filetype: mcdata
    
- name: deregister consumer zones
  actions: [mcapi-deregister=mc-partner1,mcapi-showconsumerzones=mc-partner1]
  apifile: '{{datadir2}}/federation_consumerzones_show.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_consumerzones_unreg_show.yml'
    filetype: mcdata

- name: verify that partner zones are removed as cloudlets
  actions: [mcapi-show=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_show_partner1_fedorgs.yml'
    filetype: mcdata

- name: delete federation consumers
  actions: [mcapi-delete=mc-partner1,mcapi-showfederationconsumers=mc-partner1]
  apifile: '{{datadir2}}/federation_consumers.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    fedaddr: "https://127.0.0.1:9801"
    tokenurl: "https://127.0.0.1:9900/oauth2/token"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

###############################################################
# provider clean up
###############################################################
- name: unshares provider zones
  actions: [mcapi-unshare,mcapi-showproviderzones]
  apifile: '{{datadir2}}/federation_providerzones.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: delete federation provider
  actions: [mcapi-delete,mcapi-showfederationproviders]
  apifile: '{{datadir2}}/federation_provider.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata
    
- name: delete provider zone bases
  actions: [mcapi-delete,mcapi-showproviderzonebases]
  apifile: '{{datadir2}}/federation_providerzonebases.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

###############################################################
# Delete partner1 data
###############################################################
- name: delete consumer operator data
  actions: [mcapi-delete=mc-partner1]
  apifile: '{{datadir2}}/fedcons_op_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'

- name: delete consumer platform users
  actions: [mcapi-deleteusers=mc-partner1]
  apifile: '{{datadir2}}/mc_user_fedop.yml,{{datadir2}}/mc_user_feddev.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'    

- name: delete partner1 init data
  actions: [mcapi-delete=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/federation_init_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    dnsregion: "pa"
    ctrlapiaddr: "127.0.0.1:5581"
    ctrlnotifyaddr: "127.0.0.1:27081"
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcappdata_empty.yml'
    filetype: mcdata

###############################################################
# Delete provider platform data
###############################################################
- name: user1 deletes operators and cloudlets
  actions: [mcapi-delete,mcapi-show]
  apifile: '{{datadir2}}/mc_user1_data.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_userdata_empty.yml'
    filetype: mcdata

###############################################################
# Delete mc users
###############################################################
- includefile: mc_cleanup_users.yml
