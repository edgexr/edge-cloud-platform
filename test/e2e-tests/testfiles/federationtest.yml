# Copyright 2022 MobiledgeX, Inc
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

description: Federation tests

# Unidirectional federation test.
# Main MC is the host.
# Partner1 MC is the guest.

tests:
###############################################################
# Setup host operator platform (main MC)
###############################################################
- includefile: mc_setup_users.yml

- name: user1 creates operators and cloudlets
  actions: [mcapi-create,mcapi-show]
  apifile: '{{datadir2}}/mc_user1_data.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_user1_data_show.yml'
    filetype: mcdata

###############################################################
# Setup guest operator platform (partner1 MC)
###############################################################
- name: partner1 admin disable verify email so users can be created
  actions: [mcapi-configupdate=mc-partner1,mcapi-configshow=mc-partner1]
  apifile: '{{datadir2}}/mcconfig.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcconfig_partner1.yml'
    filetype: mcconfig

- name: setup federation partner1 platform
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/federation_init_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    dnsregion: "pa"
    ctrlapiaddr: "127.0.0.1:5581"
    ctrlnotifyaddr: "127.0.0.1:27081"
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_init_data_partner1.yml'
    filetype: mcdata

- name: create partner1 platform users
  actions: [mcapi-createusers=mc-partner1]
  apifile: '{{datadir2}}/mc_user_fedop.yml,{{datadir2}}/mc_user_feddev.yml'

- name: setup federation guest (partner1) operator regional data
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_op_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_op_data_show.yml'
    filetype: mcdata

###############################################################
# Create host zone bases to map cloudlets to zones
###############################################################
- name: create host zone bases
  actions: [mcapi-create,mcapi-showhostzonebases]
  apifile: '{{datadir2}}/federation_hostzonebases.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_hostzonebases.yml'
    filetype: mcdata

###############################################################
# Create federation host
###############################################################
- name: create federation host
  actions: [mcapi-create,mcapi-showfederationhosts]
  apifile: '{{datadir2}}/federation_host.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_host_show.yml'
    filetype: mcdata

- name: share host zones
  actions: [mcapi-share,mcapi-showhostzones]
  apifile: '{{datadir2}}/federation_hostzones.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_hostzones_show.yml'
    filetype: mcdata

###############################################################
# Create federation guest, link to host
###############################################################
- name: create federation guest
  actions: [mcapi-create=mc-partner1,mcapi-showfederationguests=mc-partner1]
  apifile: '{{datadir2}}/federation_guests.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    fedaddr: "https://127.0.0.1:9801"
    tokenurl: "https://127.0.0.1:9900/oauth2/token"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_guests_show.yml'
    filetype: mcdata

- name: show guest zones
  actions: [mcapi-showguestzones=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_guestzones_show.yml'
    filetype: mcdata

- name: verify that partner zones are added as cloudlets
  actions: [mcapi-show=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_show_partner1_cloudlets.yml'
    filetype: mcdata

###############################################################
# guest onboard apps
###############################################################
- name: guest create dev regional data (apps)
  actions: [mcapi-create=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_apps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_apps_show.yml'
    filetype: mcdata

- name: guest dev onboard apps
  actions: [mcapi-create=mc-partner1,mcapi-showguestappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_consapps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_consapps_show.yml'
    filetype: mcdata

- name: host show onboarded apps
  actions: [mcapi-showhostappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_provapps_show.yml'
    filetype: mcdata

###############################################################
# guest create appinsts on host cloudlets
###############################################################
- name: guest create appinsts on host cloudlets
  actions: [mcapi-create=mc-partner1,mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_appinsts.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_appinsts_show.yml'
    filetype: mcdata

- name: check host created appinsts
  actions: [mcapi-show]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_appinsts_show.yml'
    filetype: mcdata

- name: check host MC appinst data
  actions: [mcapi-showhostappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedprov_provappinsts_show.yml'
    filetype: mcdata

- name: check direct get APIs
  actions: [mcapi-getfederationdirect=mc-partner1]
  apifile: '{{datadir2}}/fed_direct_get.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fed_direct_get_show.yml'
    
###############################################################
# guest clean up
###############################################################
- name: guest delete appinsts
  actions: [mcapi-delete=mc-partner1,mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_appinsts.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_apps_show.yml'
    filetype: mcdata

- name: guest deboard apps
  actions: [mcapi-delete=mc-partner1,mcapi-showguestappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_consapps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_images_show.yml'
    filetype: mcdata

- name: guest delete images
  actions: [mcapi-delete=mc-partner1,mcapi-showguestappdata=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_images.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: host check no more host app data
  actions: [mcapi-showhostappdata]
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: guest delete dev regional data (apps)
  actions: [mcapi-delete=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/fedcons_dev_apps.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_feddev.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/fedcons_dev_region_empty.yml'
    filetype: mcdata
    
- name: deregister guest zones
  actions: [mcapi-deregister=mc-partner1,mcapi-showguestzones=mc-partner1]
  apifile: '{{datadir2}}/federation_guestzones_show.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_guestzones_unreg_show.yml'
    filetype: mcdata

- name: verify that partner zones are removed as cloudlets
  actions: [mcapi-show=mc-partner1]
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/federation_show_partner1_fedorgs.yml'
    filetype: mcdata

- name: delete federation guests
  actions: [mcapi-delete=mc-partner1,mcapi-showfederationguests=mc-partner1]
  apifile: '{{datadir2}}/federation_guests.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    fedaddr: "https://127.0.0.1:9801"
    tokenurl: "https://127.0.0.1:9900/oauth2/token"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

###############################################################
# host clean up
###############################################################
- name: unshares host zones
  actions: [mcapi-unshare,mcapi-showhostzones]
  apifile: '{{datadir2}}/federation_hostzones.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

- name: delete federation host
  actions: [mcapi-delete,mcapi-showfederationhosts]
  apifile: '{{datadir2}}/federation_host.yml'
  apifilevars:
    partnertag: "partner1"
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata
    
- name: delete host zone bases
  actions: [mcapi-delete,mcapi-showhostzonebases]
  apifile: '{{datadir2}}/federation_hostzonebases.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_empty_object.yml'
    filetype: mcdata

###############################################################
# Delete partner1 data
###############################################################
- name: delete guest operator data
  actions: [mcapi-delete=mc-partner1]
  apifile: '{{datadir2}}/fedcons_op_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
  curuserfile: '{{datadir2}}/mc_user_fedop.yml'

- name: delete guest platform users
  actions: [mcapi-deleteusers=mc-partner1]
  apifile: '{{datadir2}}/mc_user_fedop.yml,{{datadir2}}/mc_user_feddev.yml'
  curuserfile: '{{datadir2}}/mc_admin.yml'    

- name: delete partner1 init data
  actions: [mcapi-delete=mc-partner1, mcapi-show=mc-partner1]
  apifile: '{{datadir2}}/federation_init_data.yml'
  apifilevars:
    partnertag: "partner1"
    region: "PA"
    dnsregion: "pa"
    ctrlapiaddr: "127.0.0.1:5581"
    ctrlnotifyaddr: "127.0.0.1:27081"
  curuserfile: '{{datadir2}}/mc_admin.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mcappdata_empty.yml'
    filetype: mcdata

###############################################################
# Delete host platform data
###############################################################
- name: user1 deletes operators and cloudlets
  actions: [mcapi-delete,mcapi-show]
  apifile: '{{datadir2}}/mc_user1_data.yml'
  curuserfile: '{{datadir2}}/mc_user1.yml'
  compareyaml:
    yaml1: '{{outputdir}}/show-commands.yml'
    yaml2: '{{datadir2}}/mc_userdata_empty.yml'
    filetype: mcdata

###############################################################
# Delete mc users
###############################################################
- includefile: mc_cleanup_users.yml
